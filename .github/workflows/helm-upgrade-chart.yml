---
on:
  workflow_call:
    inputs:
      runs-on:
        required: true
        type: string

      image-artifact:
        required: true
        type: string

      git-repo:
        required: true
        type: string

      chart-dir:
        required: false
        type: string
        default: .

      chart-name:
        required: true
        type: string

      gh-app-client-id:
        type: string
        required: false
        default: ""

      gh-app-id:
        type: string
        required: false
        default: ""

      gh-app-prv-key:
        type: string
        required: false
        default: ""

    secrets:
      gh-app-client-id:
        required: false
      gh-app-id:
        required: false
      gh-app-prv-key:
        required: false

jobs:
  upgrade-chart:
    runs-on: ${{ inputs.runs-on }}

    defaults:
      run:
        shell: bash

    env:
      GH_APP_ID: ${{ secrets.gh-app-id || inputs.gh-app-id }}
      GH_APP_CLIENT_ID: ${{ secrets.gh-app-client-id || inputs.gh-app-client-id }}
      GH_APP_PRV_KEY: ${{ secrets.gh-app-prv-key || inputs.gh-app-prv-key }}

    steps:
      - name: Get image value
        id: image
        uses: andreswebs/gh-actions/.github/actions/artifact-as-value@main
        with:
          key: ${{ inputs.image-artifact }}

      - name: Get app version
        id: app
        shell: bash
        env:
          IMAGE: ${{ steps.image.outputs.value }}
        run: |
          APP_VERSION=$(cut -d ':' -f 2 <(echo ${IMAGE}))
          echo "version=${APP_VERSION}" >> $GITHUB_OUTPUT

      - name: Check credentials
        run: |
          echo "${GH_APP_ID}"

          echo "${GH_APP_CLIENT_ID}"

          echo "${GH_APP_PRV_KEY}"

          [ -z "${GH_APP_ID}" ] && echo "GH_APP_ID is empty"

          [ -z "${GH_APP_CLIENT_ID}" ] && echo "GH_APP_ID is empty"

          [ -z "${GH_APP_PRV_KEY}" ] && echo "GH_APP_ID is empty"

      - name: Authenticate Git
        id: auth
        uses: andreswebs/gh-actions/.github/actions/gh-app-auth@dev
        with:
          app-id: ${{ env.gh-app-id }}
          client-id: ${{ env.gh-app-client-id }}
          prv-key: ${{ env.gh-app-prv-key }}

      - name: Upgrade Chart
        uses: andreswebs/gh-actions/.github/actions/helm-chart-upgrade-via-pr@main
        with:
          token: ${{ steps.auth.outputs.token }}
          repository: ${{ inputs.git-repo }}
          chart-dir: ${{ inputs.chart-dir }}
          chart-name: ${{ inputs.chart-name }}
          app-version: ${{ steps.app.outputs.version }}
