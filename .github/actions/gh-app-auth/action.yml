---
name: gh CLI App Auth

description: |
  Authenticates the gh CLI using GitHub App credentials.
  This action only works for private GitHub Apps with a
  single installation.

inputs:
  app-id:
    description: |
      GitHub App ID; prefer to use
      the GitHub App Client ID
    required: false
    default: ""
  client-id:
    description: GitHub App Client ID
    required: false
    default: ""
  prv-key:
    description: GitHub App Private Key
    required: true
  prv-key-path:
    description: GitHub App Private Key Path
    required: false
    default: ./key.pem

outputs:
  token:
    value: ${{ steps.auth.outputs.token }}
    description: GitHub App token

runs:
  using: composite

  steps:
    - name: Script
      shell: bash
      env:
        SCRIPTS_PATH: ${{ github.action_path }}/scripts
      run: |
        chmod +x "${SCRIPTS_PATH}/gh-app-token.sh"
        echo "${SCRIPTS_PATH}" >> $GITHUB_PATH

    - name: Credentials
      shell: bash
      env:
        GH_APP_OR_CLIENT_ID: ${{ inputs.client-id || inputs.app-id }}
        GH_APP_PRV_KEY: ${{ inputs.prv-key }}
        GH_APP_PRV_KEY_PATH: ${{ inputs.prv-key-path }}
      run: |
        echo "::add-mask::${GH_APP_PRV_KEY}"
        echo "${GH_APP_PRV_KEY}" > "${GH_APP_PRV_KEY_PATH}"
        echo "GH_APP_PRV_KEY_PATH=${GH_APP_PRV_KEY_PATH}" >> $GITHUB_ENV
        echo "GH_APP_ID=${GH_APP_ID}" >> $GITHUB_ENV
        echo "GH_APP_CLIENT_ID=${GH_APP_CLIENT_ID}" >> $GITHUB_ENV

    - name: Authenticate
      id: auth
      shell: bash
      run: |
        GH_TOKEN=$(gh-app-token.sh)
        echo "::add-mask::${GH_TOKEN}"
        echo "token=${GH_TOKEN}" >> $GITHUB_OUTPUT
        rm -f "${GH_APP_PRV_KEY_PATH}"
