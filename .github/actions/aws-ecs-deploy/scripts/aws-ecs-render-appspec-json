#!/usr/bin/env bash

set -o nounset -o errexit -o pipefail

if ! command -v aws &> /dev/null; then
    echo "error: aws is not available" >&2
    exit 1
fi

if ! command -v jq &> /dev/null; then
    echo "error: jq is not available" >&2
    exit 1
fi

TASK_DEFINITION_FAMILY="${TASK_DEFINITION_FAMILY:-}"
CONTAINER_NAME="${CONTAINER_NAME:-}"
CONTAINER_PORT="${CONTAINER_PORT:-}"

function get_task_definition_arn() {
    local task_def_family="${1}"
    aws ecs describe-task-definition \
        --task-definition "${task_def_family}" \
        --query 'taskDefinition.taskDefinitionArn' \
        --output text
}

function render_appspec() {
    local task_def_arn="${1}"
    local container_name="${2}"
    local container_port="${3}"

    appspec_json=$(
        jq \
            --null-input \
            --compact-output \
            --arg task_definition_arn "${task_def_arn}" \
            '{
              "version": 0.0,
              "Resources": [
                {
                  "TargetService": {
                    "Type": "AWS::ECS::Service",
                    "Properties": {
                      "TaskDefinition": $task_definition_arn
                    }
                  }
                }
              ]
            }'
    )

    if [ -n "${container_name}" ] && [ -n "${container_port}" ]; then
        appspec_json=$(
            echo "${appspec_json}" | \
            jq \
                --compact-output \
                --arg container_name "${container_name}" \
                --argjson container_port "${container_port}" \
                '.Resources[0].TargetService.Properties.LoadBalancerInfo = {
                    "ContainerName": $container_name,
                    "ContainerPort": $container_port
                }'
        )
    fi

    echo "${appspec_json}"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    if [ -z "${TASK_DEFINITION_FAMILY}" ]; then
        echo "error: TASK_DEFINITION_FAMILY is required but not set" >&2
        exit 1
    fi

    TASK_DEFINITION_ARN=$(get_task_definition_arn "${TASK_DEFINITION_FAMILY}")
    APPSPEC_JSON=$(render_appspec "${TASK_DEFINITION_ARN}" "${CONTAINER_NAME}" "${CONTAINER_PORT}")

    echo "${APPSPEC_JSON}"
fi
